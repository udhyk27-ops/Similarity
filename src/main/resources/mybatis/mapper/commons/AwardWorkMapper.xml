<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.java_practice.commons.mapper.AwardWorkMapper">
    <resultMap id="awardResultMap" type="Award">
        <id property="f_work_no" column="F_WORK_NO"/>
        <result property="f_title" column="F_TITLE"/>
        <result property="f_author" column="F_AUTHOR"/>
        <result property="f_year" column="F_YEAR"/>
        <result property="f_contest" column="F_CONTEST"/>
        <result property="f_award" column="F_AWARD"/>
        <result property="f_code" column="F_CODE"/>
        <result property="f_manage" column="F_MANAGE"/>
        <result property="f_host" column="F_HOST"/>
        <result property="f_reg_date" column="F_REG_DATE"/>
        <result property="f_filename" column="F_FILENAME"/>
        <result property="f_filepath" column="F_FILEPATH"/>
    </resultMap>

    <resultMap id="workStatsResultMap" type="WorkStats">
        <result property="total_cnt" column="total_cnt"/>
        <result property="valid_cnt" column="valid_cnt"/>
        <result property="invalid_cnt" column="invalid_cnt"/>
    </resultMap>

    <resultMap id="workYearStatsResultMap" type="WorkYearStats">
        <result property="f_year" column="F_YEAR"/>
        <result property="award_cnt" column="award_cnt"/>
    </resultMap>

    <select id="selectAwardListBySearch" parameterType="WorkSearch" resultMap="awardResultMap">
        select *
        from (
              select
                  F_WORK_NO,
                  F_TITLE,
                  F_AUTHOR,
                  F_YEAR,
                  F_CONTEST,
                  F_AWARD,
                  F_MANAGER,
                  F_HOST,
                  F_REG_DATE,
                  F_FILEPATH,
                  ROW_NUMBER() over (order by F_WORK_NO desc) as rn
              from T_AWARD_WORK
              where F_STATUS = 'N'
                  <if test="staDate != null and staDate != ''">
                      AND TO_CHAR(F_REG_DATE, 'YYYY-MM-DD') <![CDATA[>=]]> #{staDate}
                  </if>
                  <if test="endDate != null and endDate != ''">
                      AND TO_CHAR(F_REG_DATE, 'YYYY-MM-DD') <![CDATA[<=]]> #{endDate}
                  </if>
                  <if test="staYear != null and staYear != ''">
                      AND F_YEAR <![CDATA[>=]]> #{staYear}
                  </if>
                  <if test="endYear != null and endYear != ''">
                      AND F_YEAR <![CDATA[<=]]> #{endYear}
                  </if>
                  <if test="keyword != null and keyword != ''">
                    <choose>
                        <when test="schKeyword != null and schKeyword == 'title'">
                            AND F_TITLE like '%' || #{keyword} || '%'
                        </when>
                        <when test="schKeyword != null and schKeyword == 'author'">
                            AND F_AUTHOR like '%' || #{keyword} || '%'
                        </when>
                        <when test="schKeyword != null and schKeyword == 'host'">
                            AND F_HOST like '%' || #{keyword} || '%'
                        </when>
                        <when test="schKeyword != null and schKeyword == 'manager'">
                            AND F_MANAGER like '%' || #{keyword} || '%'
                        </when>
                        <otherwise>
                            AND (F_TITLE like '%' || #{keyword} || '%'
                                 OR F_AUTHOR like '%' || #{keyword} || '%'
                                 OR  F_HOST like '%' || #{keyword} || '%'
                                 OR F_MANAGER like '%' || #{keyword} || '%')
                        </otherwise>
                    </choose>
                  </if>
              )
        where rn between #{startRow} and #{endRow}
    </select>

    <select id="selectAwardListCnt" resultType="int">
        select count(*) from T_AWARD_WORK where F_STATUS = 'N'
    </select>

    <select id="selectAwardListCntBySearch" resultType="int">
        select count(*)
        from T_AWARD_WORK
        where F_STATUS = 'N'
            <if test="staDate != null and staDate != ''">
                AND TO_CHAR(F_REG_DATE, 'YYYY-MM-DD') <![CDATA[>=]]> #{staDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND TO_CHAR(F_REG_DATE, 'YYYY-MM-DD') <![CDATA[<=]]> #{endDate}
            </if>
            <if test="staYear != null and staYear != ''">
                AND F_YEAR <![CDATA[>=]]> #{staYear}
            </if>
            <if test="endYear != null and endYear != ''">
                AND F_YEAR <![CDATA[<=]]> #{endYear}
            </if>
            <if test="keyword != null and keyword != ''">
                <choose>
                    <when test="schKeyword != null and schKeyword == 'title'">
                        AND F_TITLE like '%' || #{keyword} || '%'
                    </when>
                    <when test="schKeyword != null and schKeyword == 'author'">
                        AND F_AUTHOR like '%' || #{keyword} || '%'
                    </when>
                    <when test="schKeyword != null and schKeyword == 'host'">
                        AND F_HOST like '%' || #{keyword} || '%'
                    </when>
                    <when test="schKeyword != null and schKeyword == 'manager'">
                        AND F_MANAGER like '%' || #{keyword} || '%'
                    </when>
                    <otherwise>
                        AND (F_TITLE like '%' || #{keyword} || '%'
                        OR F_AUTHOR like '%' || #{keyword} || '%'
                        OR  F_HOST like '%' || #{keyword} || '%'
                        OR F_MANAGER like '%' || #{keyword} || '%')
                    </otherwise>
                </choose>
            </if>
    </select>

    <select id="selectAwardListForExcel" parameterType="WorkSearch" resultMap="awardResultMap">
        select *
        from (
        select
        F_WORK_NO,
        F_FILENAME,
        F_TITLE,
        F_AUTHOR,
        F_CONTEST,
        F_AWARD,
        F_HOST,
        F_MANAGER,
        F_YEAR,
        F_REG_DATE,
        ROW_NUMBER() over (order by F_WORK_NO desc) as rn
        from T_AWARD_WORK
        where F_STATUS = 'N'
        <if test="staDate != null and staDate != ''">
            AND TO_CHAR(F_REG_DATE, 'YYYY-MM-DD') <![CDATA[>=]]> #{staDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND TO_CHAR(F_REG_DATE, 'YYYY-MM-DD') <![CDATA[<=]]> #{endDate}
        </if>
        <if test="staYear != null and staYear != ''">
            AND F_YEAR <![CDATA[>=]]> #{staYear}
        </if>
        <if test="endYear != null and endYear != ''">
            AND F_YEAR <![CDATA[<=]]> #{endYear}
        </if>
        <if test="keyword != null and keyword != ''">
            <choose>
                <when test="schKeyword != null and schKeyword == 'title'">
                    AND F_TITLE like '%' || #{keyword} || '%'
                </when>
                <when test="schKeyword != null and schKeyword == 'author'">
                    AND F_AUTHOR like '%' || #{keyword} || '%'
                </when>
                <when test="schKeyword != null and schKeyword == 'host'">
                    AND F_HOST like '%' || #{keyword} || '%'
                </when>
                <when test="schKeyword != null and schKeyword == 'manager'">
                    AND F_MANAGER like '%' || #{keyword} || '%'
                </when>
                <otherwise>
                    AND (F_TITLE like '%' || #{keyword} || '%'
                    OR F_AUTHOR like '%' || #{keyword} || '%'
                    OR  F_HOST like '%' || #{keyword} || '%'
                    OR F_MANAGER like '%' || #{keyword} || '%')
                </otherwise>
            </choose>
        </if>
        )
    </select>

    <select id="selectAwardYearList" resultType="string">
        select f_year from T_AWARD_WORK group by f_year order by F_YEAR desc
    </select>

    <update id="updateAwardStatusByWorkNo" parameterType="int">
        update T_AWARD_WORK set F_STATUS = 'Y'
        where F_WORK_NO = #{workNo}
    </update>

    <select id="chkDupAwardWork" resultType="boolean">
        select count(*) from T_AWARD_WORK where F_AUTHOR = #{f_author} and F_CONTEST = #{f_contest} and F_AWARD = #{f_award} and F_YEAR = #{f_year}
    </select>

    <insert id="insertAwardWork">
        <selectKey keyProperty="f_work_no" resultType="int" order="BEFORE">
            SELECT NVL(MAX(F_WORK_NO), 0) + 1 FROM T_AWARD_WORK
        </selectKey>
        insert into T_AWARD_WORK(F_WORK_NO, F_TITLE, F_AUTHOR, F_YEAR, F_REG_DATE, F_USER_NO, F_WORK_SIZE,
                                 F_FILENAME, F_FILEPATH, F_CONTEST, F_AWARD, F_MANAGER, F_HOST, F_MEMO)
        values (#{f_work_no}, #{f_title}, #{f_author}, #{f_year}, sysdate, #{f_user_no}, #{f_work_size},
                #{f_filename}, #{f_filepath}, #{f_contest}, #{f_award}, #{f_manager}, #{f_host}, #{f_memo})
    </insert>

    <select id="selectNextWorkNo" resultType="int">
        SELECT NVL(MAX(F_WORK_NO), 0) + 1 FROM T_AWARD_WORK
    </select>

    <insert id="insertBatchAwardWork" parameterType="list">
        insert all
        <foreach collection="list" item="award">
            into T_AWARD_WORK(F_WORK_NO, F_TITLE, F_AUTHOR, F_YEAR, F_REG_DATE, F_USER_NO, F_WORK_SIZE,
            F_FILENAME, F_FILEPATH, F_CONTEST, F_AWARD, F_MANAGER, F_HOST, F_MEMO)
            values
               (#{award.f_work_no}, #{award.f_title}, #{award.f_author}, #{award.f_year}, sysdate, #{award.f_user_no}, #{award.f_work_size},
                #{award.f_filename}, #{award.f_filepath}, #{award.f_contest}, #{award.f_award}, #{award.f_manager}, #{award.f_host}, #{award.f_memo})
        </foreach>
        select 1 from dual
    </insert>

    <select id="selectAwardWorkStats" resultMap="workStatsResultMap">
        select
            count(1) as total_cnt,
            nvl(sum(case when F_CODE is not null then 1 else 0 end), 0) as valid_cnt,
            nvl(sum(case when F_CODE is null then 1 else 0 end), 0) as invalid_cnt
        from T_AWARD_WORK
    </select>

    <select id="selectAwardYearStats" resultMap="workYearStatsResultMap">
        select F_YEAR,
               count(1) as award_cnt
        from T_AWARD_WORK group by F_YEAR
        order by F_YEAR
    </select>
</mapper>
