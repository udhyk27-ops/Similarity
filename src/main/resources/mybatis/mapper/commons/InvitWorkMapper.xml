<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.java_practice.commons.mapper.InvitWorkMapper">
    <resultMap id="invitResultMap" type="Invit">
        <id property="f_work_no" column="F_WORK_NO"/>
        <result property="f_title" column="F_TITLE"/>
        <result property="f_author" column="F_AUTHOR"/>
        <result property="f_year" column="F_YEAR"/>
        <result property="f_code" column="F_CODE"/>
        <result property="f_reg_date" column="F_REG_DATE"/>
        <result property="f_filepath" column="F_FILEPATH"/>
        <result property="f_filename" column="F_FILENAME"/>
    </resultMap>

    <resultMap id="workStatsResultMap" type="WorkStats">
        <result property="total_cnt" column="total_cnt"/>
        <result property="valid_cnt" column="valid_cnt"/>
        <result property="invalid_cnt" column="invalid_cnt"/>
    </resultMap>

    <resultMap id="workYearStatsResultMap" type="WorkYearStats">
        <result property="f_year" column="F_YEAR"/>
        <result property="invit_cnt" column="invit_cnt"/>
    </resultMap>

    <select id="selectInvitListBySearch" parameterType="WorkSearch" resultMap="invitResultMap">
        select *
        from (
                 select
                     F_WORK_NO,
                     F_TITLE,
                     F_AUTHOR,
                     F_YEAR,
                     F_CODE,
                     F_REG_DATE,
                     F_FILEPATH,
                     ROW_NUMBER() over (order by F_WORK_NO desc) as rn
                 from T_INVIT_WORK
                 where F_STATUS = 'N'
                    <if test="staDate != null and staDate != ''">
                        AND TO_CHAR(F_REG_DATE, 'YYYY-MM-DD') <![CDATA[>=]]> #{staDate}
                    </if>
                    <if test="endDate != null and endDate != ''">
                        AND TO_CHAR(F_REG_DATE, 'YYYY-MM-DD') <![CDATA[<=]]> #{endDate}
                    </if>
                    <if test="staYear != null and staYear != ''">
                        AND F_YEAR <![CDATA[>=]]> #{staYear}
                    </if>
                    <if test="endYear != null and endYear != ''">
                        AND F_YEAR <![CDATA[<=]]> #{endYear}
                    </if>
                    <if test="keyword != null and keyword != ''">
                        <choose>
                            <when test="schKeyword != null and schKeyword == 'title'">
                                AND F_TITLE like '%' || #{keyword} || '%'
                            </when>
                            <when test="schKeyword != null and schKeyword == 'author'">
                                AND F_AUTHOR like '%' || #{keyword} || '%'
                            </when>
                            <otherwise>
                                AND (F_TITLE like '%' || #{keyword} || '%'
                                OR F_AUTHOR like '%' || #{keyword} || '%')
                            </otherwise>
                        </choose>
                    </if>
                 )
        where rn between #{startRow} and #{endRow}
    </select>

    <select id="selectInvitListCnt" resultType="int">
        select count(*) from T_INVIT_WORK where F_STATUS = 'N'
    </select>

    <select id="selectInvitListCntBySearch" resultType="int">
        select count(*)
        from T_INVIT_WORK
        where F_STATUS = 'N'
            <if test="staDate != null and staDate != ''">
                AND TO_CHAR(F_REG_DATE, 'YYYY-MM-DD') <![CDATA[>=]]> #{staDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND TO_CHAR(F_REG_DATE, 'YYYY-MM-DD') <![CDATA[<=]]> #{endDate}
            </if>
            <if test="staYear != null and staYear != ''">
                AND F_YEAR <![CDATA[>=]]> #{staYear}
            </if>
            <if test="endYear != null and endYear != ''">
                AND F_YEAR <![CDATA[<=]]> #{endYear}
            </if>
            <if test="keyword != null and keyword != ''">
                <choose>
                    <when test="schKeyword != null and schKeyword == 'title'">
                        AND F_TITLE like '%' || #{keyword} || '%'
                    </when>
                    <when test="schKeyword != null and schKeyword == 'author'">
                        AND F_AUTHOR like '%' || #{keyword} || '%'
                    </when>
                    <otherwise>
                        AND (F_TITLE like '%' || #{keyword} || '%'
                        OR F_AUTHOR like '%' || #{keyword} || '%')
                    </otherwise>
                </choose>
            </if>
    </select>

    <select id="selectInvitListForExcel" parameterType="WorkSearch" resultMap="invitResultMap">
        select *
        from (
        select
        F_WORK_NO,
        F_FILENAME,
        F_TITLE,
        F_AUTHOR,
        F_CODE,
        F_YEAR,
        F_REG_DATE,
        ROW_NUMBER() over (order by F_WORK_NO desc) as rn
        from T_INVIT_WORK
        where F_STATUS = 'N'
        <if test="staDate != null and staDate != ''">
            AND TO_CHAR(F_REG_DATE, 'YYYY-MM-DD') <![CDATA[>=]]> #{staDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND TO_CHAR(F_REG_DATE, 'YYYY-MM-DD') <![CDATA[<=]]> #{endDate}
        </if>
        <if test="staYear != null and staYear != ''">
            AND F_YEAR <![CDATA[>=]]> #{staYear}
        </if>
        <if test="endYear != null and endYear != ''">
            AND F_YEAR <![CDATA[<=]]> #{endYear}
        </if>
        <if test="keyword != null and keyword != ''">
            <choose>
                <when test="schKeyword != null and schKeyword == 'title'">
                    AND F_TITLE like '%' || #{keyword} || '%'
                </when>
                <when test="schKeyword != null and schKeyword == 'author'">
                    AND F_AUTHOR like '%' || #{keyword} || '%'
                </when>
                <otherwise>
                    AND (F_TITLE like '%' || #{keyword} || '%'
                    OR F_AUTHOR like '%' || #{keyword} || '%')
                </otherwise>
            </choose>
        </if>
        )
    </select>

    <select id="selectInvitYearList" resultType="string">
        select f_year from T_INVIT_WORK group by f_year order by F_YEAR desc
    </select>

     <update id="updateInvitStatusByWorkNo" parameterType="int">
        update T_INVIT_WORK set F_STATUS = 'Y'
        where F_WORK_NO = #{workNo}
    </update>

    <select id="chkDupInvitWork" resultType="boolean">
        select count(*) from T_INVIT_WORK where F_TITLE = #{f_title} and F_AUTHOR = #{f_author} and F_YEAR = #{f_year}
    </select>

    <insert id="insertInvitWork">
        <selectKey keyProperty="f_work_no" resultType="int" order="BEFORE">
            SELECT NVL(MAX(F_WORK_NO), 0) + 1 FROM T_INVIT_WORK
        </selectKey>
        insert into T_INVIT_WORK(F_WORK_NO, F_TITLE, F_AUTHOR, F_YEAR, F_REG_DATE, F_CODE, F_USER_NO, F_WORK_SIZE, F_FILENAME, F_FILEPATH, F_MEMO)
        values(#{f_work_no}, #{f_title}, #{f_author}, #{f_year}, sysdate, #{f_code}, #{f_user_no}, #{f_work_size}, #{f_filename}, #{f_filepath}, #{f_memo})
    </insert>

    <select id="selectNextWorkNo" resultType="int">
        SELECT NVL(MAX(F_WORK_NO), 0) + 1 FROM T_INVIT_WORK
    </select>

    <insert id="insertBatchInvitWork" parameterType="list">
        insert all
        <foreach collection="list" item="invit">
            into T_INVIT_WORK(F_WORK_NO, F_TITLE, F_AUTHOR, F_YEAR, F_REG_DATE,
               F_CODE, F_USER_NO, F_WORK_SIZE, F_FILENAME, F_FILEPATH, F_MEMO)
            values(#{invit.f_work_no}, #{invit.f_title}, #{invit.f_author}, #{invit.f_year}, sysdate,
               #{invit.f_code}, #{invit.f_user_no}, #{invit.f_work_size}, #{invit.f_filename}, #{invit.f_filepath}, #{invit.f_memo})
        </foreach>
        select 1 from dual
    </insert>

    <select id="selectInvitWorkStats" resultMap="workStatsResultMap">
        select
            count(1) as total_cnt,
            nvl(sum(case when F_STATUS = 'N' then 1 else 0 end), 0) as valid_cnt,
            nvl(sum(case when F_STATUS = 'Y' then 1 else 0 end), 0) as invalid_cnt
        from T_INVIT_WORK
    </select>

    <select id="selectInvitYearStats" resultMap="workYearStatsResultMap">
        select F_YEAR,
               count(1) as invit_cnt
        from T_INVIT_WORK group by F_YEAR
        order by F_YEAR
    </select>
</mapper>
